<html>
  <head>
    <title>Land raketten</title>

    <script src="jquery.min.js" type="text/javascript"></script>
    <!--
    <script src="skulpt.min.js" type="text/javascript"></script>
    <script src="skulpt-stdlib.js" type="text/javascript"></script>
    -->
    <script src="321e8852-skulpt.min.js" type="text/javascript"></script>
    <script src="321e8852-skulpt-stdlib.js" type="text/javascript"></script>

  </head>
  <body onload="init()">
    <script type="text/javascript">
      var SVG_NS = 'http://www.w3.org/2000/svg';
      var GRAVITY = 2.0;
      var PIXELS_PER_METER = 10;
      var MOTOR_EFFECT = 3.0 * GRAVITY;
      var MOTOR_VARIATION = 0.2;
      var FUEL_USE_SPEED = 5.0;
      var MAX_LANDING_SPEED = 5.0; // m/s

      var running = false, crashing = false;
      var posY, speedY, fuelLeft, motorPower;
      var rocketSize;
      
      var rocketElem, shadowElem, rocketSizeElem;
      var dispH, dispV, dispF, dispP;
      var motorEffectsElem;
      
      function init() {
        rocketElem = document.getElementById("rocketPos");
        rocketSizeElem = document.getElementById("rocketSize");
        shadowElem = document.getElementById("shadowPos");
        dispH = document.getElementById("dispH");
        dispV = document.getElementById("dispV");
        dispF = document.getElementById("dispF");
        dispP = document.getElementById("dispP");
        motorEffectsElem = document.getElementById("motorEffects");
        resetPhysics();
        updateDisplay();
      }

      function resetPhysics() {
        posY = 40;
        speedY = 1.0;
        fuelLeft = 50;
        motorPower = 0;
        rocketSize = 1.0;
        running = true;
        crashing = false;
      }

      // Standard Normal variate using Box-Muller transform.
      function randn_bm() {
          var u = 0, v = 0;
          while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
          while(v === 0) v = Math.random();
          return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
      }
      function gaussian(mean, sigma) {return mean + sigma * randn_bm();}

      var physicsTimer = null;
      function start() {
        resetPhysics();
        if (physicsTimer != null) clearTimeout(physicsTimer);
        physicsTimer = setTimeout(loop, 0);
        runit();
      }
      function loop() {
        updateModel(0.025);
        updateDisplay();
        updateEffects();
        physicsTimer = (running || particles.length>0) ? setTimeout(loop, 25) : null;
      }
      
      function updateModel(dt) {
        if (running) {
          speedY += dt * GRAVITY;
          posY -= dt * speedY;
        }
        if (crashing) {
          rocketSize = Math.max(0, rocketSize - 3.0*dt);
        }
        var motorEfficiency = Math.max(0, gaussian(1.0, MOTOR_VARIATION));
        var motorFraction = motorPower/100.0;

        var fuelSpending = dt * motorFraction * FUEL_USE_SPEED * motorEfficiency;
        var oldFuel = fuelLeft;
        fuelLeft = Math.max(0, fuelLeft - fuelSpending);
        var motorImpulse = (oldFuel-fuelLeft) / FUEL_USE_SPEED * MOTOR_EFFECT;
        speedY -= motorImpulse;

          if (motorImpulse > 0) {
            var vy = -100.0 + 2.0 * (Math.random()-0.5);
            var vx = Math.random()-0.5;
            var vz = Math.random()-0.5;
              addParticle(0, 29 + posY * PIXELS_PER_METER, 0, 7.0*vx, vy - speedY * PIXELS_PER_METER, 7.0*vz, 3, 1.5,
                        275,275,240,255, 0.8, 0.65, 0.5, 0.4, true);
          }
          
        if (posY < 0) {
          posY = 0;
          running = false;
          // Check speed; handle any crash
          if (Math.abs(speedY) < MAX_LANDING_SPEED) {
            console.log("Win!");
            //TODO: winning actions - check and report records
          } else {
            crashed();
          }
        }
      }

      function crashed() {
        crashing = true;
        for (var i=0; i<150; i++) {
          var vx = gaussian(0, 80.0);
          var vy = gaussian(0, 150.0);
          var v = Math.sqrt(vx*vx + vy*vy);
          var sz = 20 * Math.random();
          var r = 250 + 250 * Math.random() - 0.5*v;
          var g = 250 + 100 * Math.random() - 0.5*v;
          var b = 200 + 100 * Math.random() - 0.5*v;
          addParticle(0.1*vx, 80 + 0.1*vy, 0, vx, vy, 0.0, sz, 0.2 * sz,
                        r,g,b,192.0, 0.7, 0.5, 0.2, 0.1, false);

        }
      }

      function updateDisplay() {
        var posYPixels = posY * PIXELS_PER_METER;
        rocketElem.setAttribute("transform", "translate(0," + posYPixels + ")");
        shadowElem.setAttribute("transform", "translate(0," + posYPixels + ")");
        rocketSizeElem.setAttribute("transform", rocketSize==1.0 ? "" : "scale(" + rocketSize + "," + rocketSize + ")");
        shadowElem.setAttribute("visibility", crashing ? "hidden" : "");
      dispH.textContent = posY.toFixed(1);
      dispV.textContent = speedY.toFixed(1);
      dispF.textContent = fuelLeft.toFixed(1);
      dispP.textContent = motorPower.toFixed(1);
      }

      var particles = [];
      function updateEffects() {
        for (var i=0; i<particles.length; i++) {
            updateParticle(particles[i], 0.025);
            if (particles[i].done) {
                particles[i] = particles[particles.length-1]; particles.pop();
                i--;
            }
        }
      }

function addParticle(x,y,z, vx,vy,vz, size, fsize, r,g,b,a, fr,fg,fb,fa, adjust) {
    var p = {x:x, y:y, z:z, vx:vx, vy:vy, vz:vz,
             size:size, fsize: fsize,
             r:r, g:g, b:b, a:a,
             fr:fr, fg:fg, fb:fb, fa:fa, adjust:adjust};
    var elem = document.createElementNS(SVG_NS, "circle");
    motorEffects.appendChild(elem);
    p.elem = elem;
    p.done = false;
    updateParticleUI(p);
    particles.push(p);
}

function updateParticle(p, dt) {
    var elem = p.elem;

    // Spread near the ground:
    if (p.adjust) {
    if (p.y < 0) p.y = 0.01;
    if (p.y < 1000 && p.vy < 0) {
        var k1 = 0.03;
        var k2 = 0.1;
        var r = Math.sqrt(0.0001 + p.x*p.x + p.z*p.z);
        var d = (10*p.y);// + 1.0*r);
        var dv = k1 * Math.sqrt(-p.vy) / Math.max(0.01, p.y);
        p.vy += dv;//k1/d;
        var factor = (r + k2 * dv)/r;
        p.vx *= factor; //(1 + Math.sqrt(k2/d));
        p.vz *= factor; //(1 + Math.sqrt(k2/d));
    }
    }

    p.x += dt * p.vx;
    p.y += dt * p.vy;
    p.z += dt * p.vz;
    
    p.size += dt * p.fsize; //*= Math.exp(p.fsize, dt)
    p.r *= Math.pow(p.fr, dt)
    p.g *= Math.pow(p.fg, dt)
    p.b *= Math.pow(p.fb, dt)
    p.a *= Math.pow(p.fa, dt)
    p.done = p.a < 1/255.0;

    updateParticleUI(p);
}

function updateParticleUI(p) {
    var elem = p.elem;
    elem.setAttribute("cx", ""+(p.x + 0.2 * p.z));
    elem.setAttribute("cy", ""+p.y);
    elem.setAttribute("r", ""+p.size);
    var r = Math.max(0, Math.min(255, p.r));
    var g = Math.max(0, Math.min(255, p.g));
    var b = Math.max(0, Math.min(255, p.b));
    var a = Math.max(0, Math.min(255, p.a)) / 255.0;
    elem.setAttribute("style", "stroke:none; fill:rgba("+r+","+g+","+b+","+a+");");
}
    </script>

    <script type="text/javascript">
// output functions are configurable.  This one just appends some text
// to a pre element.
function outf(text) {
    var mypre = document.getElementById("output");
    mypre.innerHTML = mypre.innerHTML + text;
}
function builtinRead(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}

function runit() {
   var prog = document.getElementById("yourcode").value;
   var mypre = document.getElementById("output");
   mypre.innerHTML = '';
   Sk.pre = "output";
   Sk.configure({output:outf, read:builtinRead});

    Sk.onAfterImport = function(library) {
      switch(library) {
      }
    }

    Sk.builtins["motorKraft"] = function (x) {motorPower = Math.max(0, Math.min(100, Sk.ffi.remapToJs(x)));};
    Sk.builtins["hoejde"] = function () {return Sk.ffi.remapToPy(posY);};
    Sk.builtins["fart"] = function () {return Sk.ffi.remapToPy(speedY);};
    Sk.builtins["braendstof"] = function () {return Sk.ffi.remapToPy(fuelLeft);};

    // Make time.sleep alias:
    Sk.builtins["vent"] = function(delay) {return Sk.misceval.callsimOrSuspend(Sk.importModule("time").$d.sleep, delay);};

   var myPromise = Sk.misceval.asyncToPromise(function() {
       return Sk.importMainWithBody("<stdin>", false, prog, true);
   });
   myPromise.then(function(mod) {
       console.log('success');
   },
        function(err) {
        alert("err: "+err);
       console.log(err.toString());
   });
}
    </script>


    <div style="display: table">
    <div style="float: left;">
    <svg
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns="http://www.w3.org/2000/svg"
      width="400"
      height="600"
      version="1.1">

      <g transform="translate(140 500) scale(1,-1)"> <!-- Center -->
        <!-- Background -->
      <path style="fill:rgb(20,20,20); stroke:none" d="M-500,-500 L500,-500 L500,500 L-500,500 z"/>
      <path style="fill:rgb(150,150,128); stroke:none" d="M-500,-200 L500,-200 L500,30 L-500,30 z"/>

        <g id="rocketPos" transform=""><g id="rocketSize" transform="">
      <g transform="scale(1,-1) translate(0 -180)"> <!-- Normalize -->
      <path style="stroke:white; fill:rgb(150,150,255); stroke-width:1"
            d="M 0,0 C 20,20 40,50 40,100
               L40,150 L55,180 L25,180
               Q 0,120 -25,180 L-55,180 L-40,150
               L-40,100 C-40,50 -20,20 0,0 z"/>

      <circle style="stroke:rgb(100,100,150); fill:rgb(50,50,150); stroke-width:3;"
              cx="1" cy="101" r="19"/>
      <circle style="stroke:rgb(230,230,230); fill:rgb(50,50,150); stroke-width:3;"
              cx="0" cy="100" r="18"/>
      </g>
      </g>
      </g>
        
        <g transform="skewX(-55) scale(1,-0.3)"> <!-- Center -->
          <g id="shadowPos" transform="">
            <g transform="scale(1,-1) translate(0 -180)"> <!-- Normalize -->
              <path style="stroke:none; fill:rgb(90,90,90); fill-opacity: 0.7"
                    d="M 0,0 C 20,20 40,50 40,100
                       L40,150 L55,180 L25,180
                       Q 0,120 -25,180 L-55,180 L-40,150
                       
                       L-40,100 C-40,50 -20,20 0,0 z"/>

            </g>
          </g>
        </g>

        <g id="motorEffects">
    </g>
        </g>
      <g transform="translate(210,40)"> <!-- Value displays -->
          <text style="fill:rgb(255,240,0)">
            <tspan x="0" y="0">Højde:</tspan>
            <tspan x="0" dy="25">Fart:</tspan>
            <tspan x="0" dy="25">Brændstof:</tspan>
            <tspan x="0" dy="25">Motorkraft:</tspan>

            <tspan x="150" y="0">m</tspan>
            <tspan x="150" dy="25">m/s</tspan>
            <tspan x="150" dy="25">L</tspan>
            <tspan x="150" dy="25">%</tspan>
            <tspan text-anchor="end"><!--
              --><tspan id="dispH" x="140" y="0">?</tspan><!--
              --><tspan id="dispV" x="140" dy="25">??</tspan><!--
              --><tspan id="dispF" x="140" dy="25">???</tspan><!--
              --><tspan id="dispP" x="140" dy="25" style="fill:rgb(255,190,0)">??</tspan><!--
            --></tspan>
          </text>
        </g>

    </svg>
    </div>
    <div style="overflow: hidden; padding-left: 1em;">
      <h1>Land raketten!</h1>
      <p>Du skal skrive styreprogrammet til rakettens kontrol-computer.</p>
      <p>Computeren styrer én ting: motoren.</p>
      <p>Computeren har 3 sensorer: En højdemåler, en fartmåler, og en brændstofmåler.</p>
      <p>
        <textarea id="yourcode" cols="40" rows="10" style="font-family: monospace; font-size: 12pt;">motorKraft(100)
vent(1)
motorKraft(0)
        </textarea>
        <p>
          <button onClick="start()">Start</button>
        </p>
        <pre id="output" ></pre>
      </p>
    </div>
    </div>
  </body>

</html>
